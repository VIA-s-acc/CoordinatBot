# –°–∏—Å—Ç–µ–º–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ª–∏—Å—Ç–æ–≤ Google Sheets

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Å–ø–∏—Å–∫–æ–≤ –ª–∏—Å—Ç–æ–≤ –∏ —Ç–∞–±–ª–∏—Ü, –∫–µ—à–∏—Ä—É—è –¥–∞–Ω–Ω—ã–µ –Ω–∞ 30 –º–∏–Ω—É—Ç –∏ –∏–∑–±–µ–≥–∞—è —á–∞—Å—Ç—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ API Google Sheets.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. SheetsCache (`src/utils/sheets_cache.py`)

–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–µ—à–µ–º:
- **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞**: 30 –º–∏–Ω—É—Ç (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç threading.Lock
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –∫–µ—à–∞

#### –ö–µ—à–∏—Ä—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:
- **–°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü**: —Ä–µ–∑—É–ª—å—Ç–∞—Ç `get_all_spreadsheets()`
- **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏—Å—Ç–∞—Ö**: —Ä–µ–∑—É–ª—å—Ç–∞—Ç `get_worksheets_info(spreadsheet_id)`

### 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±–µ—Ä—Ç–∫–∏

```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–µ—à–∞
sheets_info, title = get_cached_sheets_info(spreadsheet_id)
spreadsheets = get_cached_spreadsheets()

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ—à–µ–º
invalidate_sheets_cache(spreadsheet_id)
invalidate_spreadsheets_cache()
clear_all_cache()
get_cache_statistics()
```

### 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–µ—à–µ–º (`src/bot/handlers/cache_handlers.py`)

–ê–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–µ—à–µ–º:
- **üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–µ—à–µ
- **üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–µ—à —Ç–∞–±–ª–∏—Ü** - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
- **üóë –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–µ—à** - –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –î–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∫–µ—à–∞:
- ‚è±Ô∏è –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ –ª–∏—Å—Ç–æ–≤ = API –≤—ã–∑–æ–≤ (1-3 —Å–µ–∫—É–Ω–¥—ã)
- üîÑ –ß–∞—Å—Ç—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ Google API
- üì± –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

### –ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∫–µ—à–∞:
- ‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∫–µ—à–∞ (< 0.1 —Å–µ–∫—É–Ω–¥—ã)
- üöÄ –ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ª–∏—Å—Ç–∞–º–∏
- üíæ –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Google API

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∫–æ–¥

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:

1. **`show_sheet_selection_for_add_record()`**:
   ```python
   # –ë—ã–ª–æ:
   sheets_info, title = get_worksheets_info(spreadsheet_id)
   
   # –°—Ç–∞–ª–æ:
   sheets_info, title = get_cached_sheets_info(spreadsheet_id)
   ```

2. **`select_spreadsheet_menu()`**:
   ```python
   # –ë—ã–ª–æ:
   spreadsheets = get_all_spreadsheets()
   
   # –°—Ç–∞–ª–æ:
   spreadsheets = get_cached_spreadsheets()
   ```

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `src/bot/handlers/button_handlers.py` ‚úÖ
- `src/bot/handlers/button_handlers_new.py` ‚úÖ
- `src/bot/keyboards/inline_keyboards.py` ‚úÖ (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

## –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞

### –î–æ—Å—Ç—É–ø –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é:
1. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚Üí ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
2. üóÇ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ—à–µ–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)

### –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

#### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –∏ –ª–∏—Å—Ç–æ–≤
- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –î–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ

#### üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–µ—à —Ç–∞–±–ª–∏—Ü
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
- –ü–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü –≤ Google Drive

#### üóë –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–µ—à
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ—Ç –∫–µ—à
- –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –∑–∞–Ω–æ–≤–æ

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–µ—à–∞:

```python
# –ö–µ—à –ª–∏—Å—Ç–æ–≤
_sheets_cache = {
    "spreadsheet_id": (sheets_info, spreadsheet_title, timestamp),
    ...
}

# –ö–µ—à —Ç–∞–±–ª–∏—Ü
_spreadsheets_cache = (spreadsheets_list, timestamp)
```

### –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: –ö–µ—à —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–º —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç
2. **Fallback –Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫–µ—à**: –ü—Ä–∏ –æ—à–∏–±–∫–µ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –∫–µ—à
3. **Graceful degradation**: –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–µ—à–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

- üõ°Ô∏è **API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω**: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫–µ—à + –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö
- üîÑ **–ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**: –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
- üìù **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫–µ—à–µ–º –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏:
```
INFO: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∫–µ—à –ª–∏—Å—Ç–æ–≤ —Å –ø–µ—Ä–∏–æ–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è 30 –º–∏–Ω—É—Ç
DEBUG: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ª–∏—Å—Ç–∞—Ö –∏–∑ –∫–µ—à–∞ –¥–ª—è spreadsheet_123
INFO: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ª–∏—Å—Ç–∞—Ö –¥–ª—è spreadsheet_123
WARNING: –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫–µ—à –¥–ª—è spreadsheet_123
```

### –ú–µ—Ç—Ä–∏–∫–∏ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫–µ—à
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–º–∞—Ö–æ–≤ –∫–µ—à–∞
- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –†–∞–∑–º–µ—Ä –∫–µ—à–∞

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:
```python
# –í src/utils/sheets_cache.py
sheets_cache = SheetsCache(cache_duration_minutes=60)  # 1 —á–∞—Å
```

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–µ—à–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏):
```python
# –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å force_refresh=True
sheets_info, title = get_cached_sheets_info(spreadsheet_id, force_refresh=True)
```

## –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã:
- **–í—ã–±–æ—Ä –ª–∏—Å—Ç–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏**: –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏**: –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- **–ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**: –∫–∞–∫ –æ–±—ã—á–Ω–æ (–∫–µ—à –ø—É—Å—Ç–æ–π)

### –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:
- –î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –¥–æ 30 –º–∏–Ω—É—Ç
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏

–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–æ–≤ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —á–∞—Å—Ç–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –ª–∏—Å—Ç–∞–º–∏ –∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏.
