# План по устранению дублирования данных в отчетах

## Проблема
При генерации отчетов для пользователя `Гриша 8 микро` создаются два отдельных файла вместо одного, что приводит к дублированию данных.

## Причина
В файле `src/bot/handlers/button_handlers.py` (строка 227) вызывается функция `generate_user_report`, которая отличается от функции в `src/utils/report_manager.py`. Это приводит к созданию двух отдельных отчетов:
1. Отчет из `button_handlers.py` (строка 770) - простой отчет в формате Excel
2. Отчет из `report_manager.py` (строка 149) - расширенный отчет с дедупликацией и аналитикой

## Решение
Необходимо унифицировать процесс генерации отчетов, чтобы использовать только одну функцию из `report_manager.py`, которая уже содержит механизмы дедупликации и более полную функциональность.

## Шаги по устранению

1. **Удалить дублирующую функцию в button_handlers.py**
   - Удалить функцию `generate_user_report` (строки 770-844)
   - Обновить импорт в строке 227, чтобы использовать функцию из `report_manager.py`

2. **Обновить вызов функции в button_handler**
   - Заменить вызов `await generate_user_report(update, context, display_name)` на `await generate_user_report(display_name, update, context)`

3. **Добавить проверку на существование записей**
   - В функции `generate_user_report` из `report_manager.py` добавить проверку на наличие записей перед генерацией отчета

4. **Тестирование**
   - Проверить генерацию отчетов для пользователей с записями
   - Проверить генерацию отчетов для пользователей без записей
   - Убедиться, что отчеты генерируются в правильном формате и без дубликатов

## Ожидаемый результат
После внесения изменений:
- Для каждого пользователя будет генерироваться только один отчет
- Отчеты будут содержать дедуплицированные данные
- Сохранится вся функциональность расширенных отчетов из `report_manager.py`
- Улучшится производительность за счет удаления дублирующего кода