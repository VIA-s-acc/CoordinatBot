# Интеграция Volume для Fly.io

Этот документ описывает изменения, внесенные для поддержки постоянного хранения данных на fly.io с использованием volume.

## Основные изменения

### 1. Конфигурация Fly.io

В файл `fly.toml` добавлена конфигурация volume:

```toml
# Конфигурация volume для постоянного хранения данных
[[mounts]]
  source = 'coordinatbot_data'
  destination = '/data'
```

### 2. Параметры запуска

Теперь бот поддерживает два режима запуска:

- `-dep` или `--deploy` - режим деплоя (использует `/data` volume)
- `-loc` или `--local` - локальный режим (использует `./data`)

По умолчанию используется режим деплоя.

### 3. Механизм копирования данных

При первом запуске в режиме деплоя, если volume пуст, данные автоматически копируются из локальной папки `data/` в volume `/data`.

## Использование

### Локальный запуск

```bash
python -m src.main -loc
```

### Запуск в режиме деплоя

```bash
python -m src.main -dep
```

### Запуск через Docker (для fly.io)

```bash
python -m src.main -dep
```

## Структура данных

В режиме деплоя все файлы данных хранятся в `/data`:
- `/data/users.json`
- `/data/allowed_users.json`
- `/data/bot_config.json`
- `/data/expenses.db`

В локальном режиме файлы хранятся в `./data` как и раньше.

## Миграция данных

При первом деплое на fly.io:
1. Убедитесь, что локальная папка `data/` содержит все необходимые файлы
2. Запустите бот с параметром `-dep`
3. Данные автоматически скопируются из `./data` в `/data` volume
4. Последующие запуски будут использовать данные из volume

## Важно

- Не удаляйте volume на fly.io, это приведет к потере данных
- При локальной разработке используйте параметр `-loc`
- Резервные копии создаются и восстанавливаются в правильное расположение в зависимости от режима

## Тестирование

Перед деплоем на fly.io рекомендуется протестировать локально:

1. Создайте тестовые данные в `./data`
2. Запустите бот в режиме деплоя: `python -m src.main -dep`
3. Убедитесь, что данные скопировались в `/data` (или в тестовую директорию)
4. Перезапустите бот и убедитесь, что данные сохраняются между запусками