# CoordinatBot - Նորացումներ և բարելավումներ

## 📋 Ընդհանուր նկարագրություն

CoordinatBot-ը բիզնես գործողությունների հետևման բոտ է, որը ներառում է Google Sheets ինտեգրացիա, ծախսերի գրառում և վճարային համակարգ:

## 🚀 Վերջին նորացումները

### 1. Ասինխրոն Google Sheets մշակում

#### ⚠️ Խնդիրը
Նախկինում Google Sheets-ի հետ աշխատանքը սինխրոն էր, ինչը:
- **Խափանում էր բոտը** 3-5 վայրկյանով յուրաքանչյուր գրառման ժամանակ
- **Բացասաբար ազդում էր** օգտատերերի փորձի վրա
- **Չէր թույլատրում** միաժամանակ բազմաթիվ գործողություններ

#### ✅ Լուծումը
Ստեղծվել է **ասինխրոն արբեց (worker) համակարգ**:

```
🔄 AsyncSheetsWorker
├── 4 զուգահեռ արբեց
├── Առաջնության հերթ (priority queue)
├── Ավտոմատ կրկնության մեխանիզմ (3 փորձ)
└── Մանրամասն լոգավորում
```

#### 📊 Արդյունքները
| Ցուցանիշ | Մինչև | Հիմա |
|----------|-------|------|
| Բոտի արձագանքը | 3-5 վրկ | 0.1 վրկ |
| Միաժամանակյա գործողություններ | ❌ | ✅ |
| Գունկերի կայունությունը | Անկայուն | Կայուն |
| Սխալների մշակում | Ավտոմատ փակում | Ճկուն կրկնություն |

### 2. Ամսաթվային համակարգի բարելավում

#### ⚠️ Խնդիրը
Ամսաթվերի մշակման մեջ առկա էին:
- **"unconverted data remains"** սխալ
- Բոտի փակումներ ամսաթվի սխալ ձևաչափի պատճառով
- Սահմանափակ ամսաթվային ձևաչափների աջակցություն

#### ✅ Լուծումը
Ստեղծվել է **ապահով ամսաթվային մշակման համակարգ**:

```python
# Նոր safe_parse_date ֆունկցիան
safe_parse_date("10.10.24")    → 2024-10-10
safe_parse_date("10․10․24")    → 2024-10-10 (հայերեն կետեր)
safe_parse_date("2024-10-10")  → 2024-10-10
safe_parse_date("invalid")     → None (առանց սխալի)
```

#### 📅 Աջակցվող ամսաթվային ձևաչափներ
1. `DD.MM.YY` - 10.10.24
2. `DD.MM.YYYY` - 10.10.2024
3. `YYYY-MM-DD` - 2024-10-10
4. `DD-MM-YYYY` - 10-10-2024
5. `DD/MM/YY` - 10/10/24
6. `DD/MM/YYYY` - 10/10/2024
7. `DD․MM․YY` - 10․10․24 (հայերեն կետեր)
8. `DD․MM․YYYY` - 10․10․2024 (հայերեն կետեր)

### 3. Ծանուցումների մաքրում

#### ⚠️ Խնդիրը
Բոտի զրույցները լցվում էին:
- Սխալ գրառումների ծանուցումներով
- Ընդմիջական հրահանգներով
- Անհարկի հաղորդագրություններով

#### ✅ Լուծումը
Ավտոմատ **հաղորդագրությունների ջնջման համակարգ**:

```
👤 Օգտատեր: "5000" (սխալ ձևաչափ)
🤖 Բոտ: "❌ Սխալ ձևաչափ"
👤 Օգտատեր: "5000.50" (ճիշտ)
🤖 Բոտ: "✅ Գրառումը ավելացվել է" + ջնջվում են նախկին սխալները
```

### 4. Google Sheets գրառումների թարմացման ուղղում

#### ⚠️ Խնդիրը
Google Sheets-ում գրառումների խմբագրման ժամանակ:
- **"Запись не найдена для обновления"** սխալ
- Գրառումները չէին գտնվում ID-ով
- Ամսաթիվների խմբագրումը չէր աշխատում
- **Սորտավորման ժամանակ ջնջվում էին գրառումները** մեկական մշակման պատճառով

#### ✅ Լուծումը
Բարելավված **update_record_in_sheet** և **sort_sheet_by_date** ֆունկցիաներ:

```python
# Ավելի ճշգրիտ գրառման որոնում
for i, row in enumerate(records, start=2):
    row_id = str(row.get('ID', '')).strip()
    if row_id == record_id:
        record_found = True
        # Մանրամասն լոգավորում
        logger.info(f"Найдена запись {record_id} в строке {i}")
        break

# Խելացի սորտավորում - միայն անհրաժեշտության դեպքում
if need_resort:
    # Պակետային թարմացում՝ առանց ջնջելու
    worksheet.update(range_name, sorted_data, value_input_option='USER_ENTERED')
    
# Ամսաթիվների անվտանգ մշակում
if field == 'date':
    parsed_date = safe_parse_date_or_none(new_value)
    if parsed_date:
        formatted_value = parsed_date.strftime('%d.%m.%y')
```

## 🛠️ Տեխնիկական մանրամասություններ

### Ասինխրոն արբեց (AsyncSheetsWorker)

```python
class AsyncSheetsWorker:
    def __init__(self, max_workers: int = 4):
        self.task_queue = Queue()
        self.workers = []
        
    def _worker_loop(self):
        """Հիմնական ցիկլ յուրաքանչյուր արբեցի համար"""
        while self.running:
            task = self.task_queue.get(timeout=1.0)
            success = self._process_task(task)
            if not success:
                self._retry_task(task)
```

### Ապահով ամսաթվային մշակում

```python
def safe_parse_date(date_str: str) -> datetime.date:
    """Ապահով ամսաթվի մշակում բազմաթիվ ձևաչափների աջակցությամբ"""
    date_formats = [
        '%d.%m.%y', '%d.%m.%Y', '%Y-%m-%d', 
        '%d-%m-%Y', '%d/%m/%Y', '%d․%m․%y'
    ]
    
    for fmt in date_formats:
        try:
            return datetime.strptime(date_str, fmt).date()
        except ValueError:
            continue
    
    raise ValueError(f"Չհաջողվեց մշակել ամսաթիվը: {date_str}")
```

## 📈 Կատարելագործման ցուցանիշներ

### Google Sheets ինտեգրացիա
- **Նախկինում**: Սինխրոն, 3-5վրկ ակնկալիք
- **Հիմա**: Ասինխրոն, 0.1վրկ պատասխան + ֆոնային մշակում

### Ամսաթվային մշակում
- **Նախկինում**: 1 ձևաչափ, հաճախակի սխալներ
- **Հիմա**: 8 ձևաչափ, ապահով մշակում

### Հաղորդագրությունների կառավարում
- **Նախկինում**: Լցված զրույցներ
- **Հիմա**: Մաքուր, կազմակերպված զրույցներ

## 🏗️ Ֆայլային կառուցվածք

```
src/
├── google_integration/
│   ├── async_sheets_worker.py    # Ասինխրոն արբեցներ
│   └── sheets_manager.py         # Google Sheets API
├── utils/
│   ├── date_utils.py            # Ամսաթվային ֆունկցիաներ
│   └── payment_utils.py         # Վճարային գործիքներ
├── bot/handlers/
│   ├── record_handlers.py       # Գրառումների մշակում
│   ├── edit_handlers.py         # Խմբագրման գործողություններ
│   └── payment_handlers.py      # Վճարային գործողություններ
└── main.py                      # Հիմնական նախաձեռնում
```

## 🔧 Տեղադրում և գործարկում

### Նախապայմաններ
```bash
pip install python-telegram-bot
pip install gspread oauth2client
pip install pandas openpyxl
```

### Գործարկում
```bash
cd CoordinatBot
python src/main.py
```

### Կարգավորումներ
1. **Google Sheets մուտք**: `credentials/` պանակում տեղադրել JSON ֆայլը
2. **Բոտի տոկեն**: `.env` ֆայլում սահմանել `TOKEN=`
3. **Ադմինիստրատորներ**: `config/settings.py`-ում սահմանել `ADMIN_IDS`

## 📋 Գործառույթներ

### Հիմնական հրամաններ
- `/start` - Բոտի գործարկում
- `/menu` - Հիմնական ցանկ
- `/help` - Օգնություն

### Ադմինիստրատիվ հրամաններ
- `/allow_user` - Օգտատերի թույլտվություն
- `/export` - Տվյալների արտահանում
- `/sync_sheets` - Google Sheets սինխրոնացում
- `/set_sheet` - Աղյուսակի ընտրություն

### Հիմնական գործառույթներ
1. **Գրառումների ավելացում** - Ծախսերի և եկամուտների գրառում
2. **Բացթողումների գրառում** - Առանց ծախսի օրերի նշում
3. **Վճարների կառավարում** - Վճարային ներածական և արտածական
4. **Զեկույցների ստեղծում** - Excel ֆորմատով արտահանում
5. **Google Sheets սինխրոնացում** - Ավտոմատ թարմացումներ

## 🔐 Անվտանգություն

### Մուտքի վերահսկում
- Ադմինիստրատորային հրամաններ միայն թույլատրված օգտատերերի համար
- Օգտատերերը կարող են խմբագրել միայն իրենց գրառումները
- Ապահով Google Sheets API մուտք

### Տվյալների պահպանում
- Տեղական SQLite բազա տվյալների համար
- Ավտոմատ պահուստավորման համակարգ
- Մանրամասն գործողությունների լոգավորում

## 🐛 Սխալների վարում

### Ասինխրոն սխալներ
```python
try:
    success = sheets_manager.add_record_to_sheet(...)
    if not success:
        retry_task_with_backoff(task)
except Exception as e:
    log_error_and_continue(e)
```

### Ամսաթվային սխալներ
```python
parsed_date = safe_parse_date_or_none(date_string)
if parsed_date is None:
    log_warning_and_skip_record(date_string)
    continue
```

## 🔄 Արդիացման պատմություն

### v2.0.0 (Ընթացիկ)
- ✅ Ասինխրոն Google Sheets մշակում
- ✅ Բարելավված ամսաթվային համակարգ  
- ✅ Հաղորդագրությունների ավտոմատ մաքրում
- ✅ Կայուն սխալների վարում
- ✅ Գրառումների թարմացման սխալների ուղղում

### v1.0.0
- ✅ Հիմնական բոտի գործառույթներ
- ✅ Google Sheets ինտեգրացիա
- ✅ Օգտատերերի կառավարում
- ✅ Վճարային համակարգ

## 💡 Ապագա ծրագրեր

- [ ] Վեբ ինտերֆեյս ավելացում
- [ ] Մոբիլային հավելված
- [ ] BI դաշտ (dashboard) ինտեգրացիա  
- [ ] Ավտոմատ զեկույցների առաքում
- [ ] Բազմալեզու աջակցություն ընդլայնում

## 📞 Աջակցություն

Խնդիրների կամ առաջարկությունների դեպքում կարող եք:
1. Ստեղծել GitHub Issue
2. Կապվել ծրագրավորողների հետ
3. Ուղարկել լոգ ֆայլեր սխալի վերլուծության համար

---

**Նշում**: Այս բոտը մշակվել է հատուկ CoordinatBot ծրագրի համար և պահանջում է համապատասխան կարգավորումներ Google Sheets API-ի և Telegram Bot API-ի համար:
