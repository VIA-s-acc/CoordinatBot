# CoordinatBot - ีีธึีกึีธึีดีถีฅึ ึ ีขีกึีฅีฌีกีพีธึีดีถีฅึ

## ๐ ิธีถีคีฐีกีถีธึึ ีถีฏีกึีกีฃึีธึีฉีตีธึีถ

CoordinatBot-ีจ ีขีซีฆีถีฅีฝ ีฃีธึีฎีธีฒีธึีฉีตีธึีถีถีฅึีซ ีฐีฅีฟึีดีกีถ ีขีธีฟ ีง, ีธึีจ ีถีฅึีกีผีธึีด ีง Google Sheets ีซีถีฟีฅีฃึีกึีซีก, ีฎีกีญีฝีฅึีซ ีฃึีกีผีธึีด ึ ีพีณีกึีกีตีซีถ ีฐีกีดีกีฏีกึีฃ:

## ๐ ีีฅึีปีซีถ ีถีธึีกึีธึีดีถีฅึีจ

### 1. ิฑีฝีซีถีญึีธีถ Google Sheets ีดีทีกีฏีธึีด

#### โ๏ธ ิฝีถีคีซึีจ
ีีกีญีฏีซีถีธึีด Google Sheets-ีซ ีฐีฅีฟ ีกีทีญีกีฟีกีถึีจ ีฝีซีถีญึีธีถ ีงึ, ีซีถีนีจ:
- **ิฝีกึีกีถีธึีด ีงึ ีขีธีฟีจ** 3-5 ีพีกีตึีฏีตีกีถีธีพ ีตีธึึีกึีกีถีนีตีธึึ ีฃึีกีผีดีกีถ ีชีกีดีกีถีกีฏ
- **ิฒีกึีกีฝีกีขีกึ ีกีฆีคีธึีด ีงึ** ึีฃีฟีกีฟีฅึีฅึีซ ึีธึีฑีซ ีพึีก
- **ีีงึ ีฉีธึีตีฌีกีฟึีธึีด** ีดีซีกีชีกีดีกีถีกีฏ ีขีกีฆีดีกีฉีซีพ ีฃีธึีฎีธีฒีธึีฉีตีธึีถีถีฅึ

#### โ ิผีธึีฎีธึีดีจ
ีีฟีฅีฒีฎีพีฅีฌ ีง **ีกีฝีซีถีญึีธีถ ีกึีขีฅึ (worker) ีฐีกีดีกีฏีกึีฃ**:

```
๐ AsyncSheetsWorker
โโโ 4 ีฆีธึีฃีกีฐีฅีผ ีกึีขีฅึ
โโโ ิฑีผีกีปีถีธึีฉีตีกีถ ีฐีฅึีฉ (priority queue)
โโโ ิฑีพีฟีธีดีกีฟ ีฏึีฏีถีธึีฉีตีกีถ ีดีฅีญีกีถีซีฆีด (3 ึีธึีฑ)
โโโ ีีกีถึีกีดีกีฝีถ ีฌีธีฃีกีพีธึีธึีด
```

#### ๐ ิฑึีคีตีธึีถึีถีฅึีจ
| ีีธึึีกีถีซีท | ีีซีถีนึ | ีีซีดีก |
|----------|-------|------|
| ิฒีธีฟีซ ีกึีฑีกีฃีกีถึีจ | 3-5 ีพึีฏ | 0.1 ีพึีฏ |
| ีีซีกีชีกีดีกีถีกีฏีตีก ีฃีธึีฎีธีฒีธึีฉีตีธึีถีถีฅึ | โ | โ |
| ิณีธึีถีฏีฅึีซ ีฏีกีตีธึีถีธึีฉีตีธึีถีจ | ิฑีถีฏีกีตีธึีถ | ิฟีกีตีธึีถ |
| ีีญีกีฌีถีฅึีซ ีดีทีกีฏีธึีด | ิฑีพีฟีธีดีกีฟ ึีกีฏีธึีด | ีีฏีธึีถ ีฏึีฏีถีธึีฉีตีธึีถ |

### 2. ิฑีดีฝีกีฉีพีกีตีซีถ ีฐีกีดีกีฏีกึีฃีซ ีขีกึีฅีฌีกีพีธึีด

#### โ๏ธ ิฝีถีคีซึีจ
ิฑีดีฝีกีฉีพีฅึีซ ีดีทีกีฏีดีกีถ ีดีฅีป ีกีผีฏีก ีงีซีถ:
- **"unconverted data remains"** ีฝีญีกีฌ
- ิฒีธีฟีซ ึีกีฏีธึีดีถีฅึ ีกีดีฝีกีฉีพีซ ีฝีญีกีฌ ีฑึีกีนีกึีซ ีบีกีฟีณีกีผีธีพ
- ีีกีฐีดีกีถีกึีกีฏ ีกีดีฝีกีฉีพีกีตีซีถ ีฑึีกีนีกึีถีฅึีซ ีกีปีกีฏึีธึีฉีตีธึีถ

#### โ ิผีธึีฎีธึีดีจ
ีีฟีฅีฒีฎีพีฅีฌ ีง **ีกีบีกีฐีธีพ ีกีดีฝีกีฉีพีกีตีซีถ ีดีทีกีฏีดีกีถ ีฐีกีดีกีฏีกึีฃ**:

```python
# ีีธึ safe_parse_date ึีธึีถีฏึีซีกีถ
safe_parse_date("10.10.24")    โ 2024-10-10
safe_parse_date("10โค10โค24")    โ 2024-10-10 (ีฐีกีตีฅึีฅีถ ีฏีฅีฟีฅึ)
safe_parse_date("2024-10-10")  โ 2024-10-10
safe_parse_date("invalid")     โ None (ีกีผีกีถึ ีฝีญีกีฌีซ)
```

#### ๐ ิฑีปีกีฏึีพีธีฒ ีกีดีฝีกีฉีพีกีตีซีถ ีฑึีกีนีกึีถีฅึ
1. `DD.MM.YY` - 10.10.24
2. `DD.MM.YYYY` - 10.10.2024
3. `YYYY-MM-DD` - 2024-10-10
4. `DD-MM-YYYY` - 10-10-2024
5. `DD/MM/YY` - 10/10/24
6. `DD/MM/YYYY` - 10/10/2024
7. `DDโคMMโคYY` - 10โค10โค24 (ีฐีกีตีฅึีฅีถ ีฏีฅีฟีฅึ)
8. `DDโคMMโคYYYY` - 10โค10โค2024 (ีฐีกีตีฅึีฅีถ ีฏีฅีฟีฅึ)

### 3. ิพีกีถีธึึีธึีดีถีฅึีซ ีดีกึึีธึีด

#### โ๏ธ ิฝีถีคีซึีจ
ิฒีธีฟีซ ีฆึีธึีตึีถีฅึีจ ีฌึีพีธึีด ีงีซีถ:
- ีีญีกีฌ ีฃึีกีผีธึีดีถีฅึีซ ีฎีกีถีธึึีธึีดีถีฅึีธีพ
- ิธีถีคีดีซีปีกีฏีกีถ ีฐึีกีฐีกีถีฃีถีฅึีธีพ
- ิฑีถีฐีกึีฏีซ ีฐีกีฒีธึีคีกีฃึีธึีฉีตีธึีถีถีฅึีธีพ

#### โ ิผีธึีฎีธึีดีจ
ิฑีพีฟีธีดีกีฟ **ีฐีกีฒีธึีคีกีฃึีธึีฉีตีธึีถีถีฅึีซ ีปีถีปีดีกีถ ีฐีกีดีกีฏีกึีฃ**:

```
๐ค ีีฃีฟีกีฟีฅึ: "5000" (ีฝีญีกีฌ ีฑึีกีนีกึ)
๐ค ิฒีธีฟ: "โ ีีญีกีฌ ีฑึีกีนีกึ"
๐ค ีีฃีฟีกีฟีฅึ: "5000.50" (ีณีซีทีฟ)
๐ค ิฒีธีฟ: "โ ิณึีกีผีธึีดีจ ีกีพีฅีฌีกึีพีฅีฌ ีง" + ีปีถีปีพีธึีด ีฅีถ ีถีกีญีฏีซีถ ีฝีญีกีฌีถีฅึีจ
```

### 4. Google Sheets ีฃึีกีผีธึีดีถีฅึีซ ีฉีกึีดีกึีดีกีถ ีธึีฒีฒีธึีด

#### โ๏ธ ิฝีถีคีซึีจ
Google Sheets-ีธึีด ีฃึีกีผีธึีดีถีฅึีซ ีญีดีขีกีฃึีดีกีถ ีชีกีดีกีถีกีฏ:
- **"ะะฐะฟะธัั ะฝะต ะฝะฐะนะดะตะฝะฐ ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั"** ีฝีญีกีฌ
- ิณึีกีผีธึีดีถีฅึีจ ีนีงีซีถ ีฃีฟีถีพีธึีด ID-ีธีพ
- ิฑีดีฝีกีฉีซีพีถีฅึีซ ีญีดีขีกีฃึีธึีดีจ ีนีงึ ีกีทีญีกีฟีธึีด
- **ีีธึีฟีกีพีธึีดีกีถ ีชีกีดีกีถีกีฏ ีปีถีปีพีธึีด ีงีซีถ ีฃึีกีผีธึีดีถีฅึีจ** ีดีฅีฏีกีฏีกีถ ีดีทีกีฏีดีกีถ ีบีกีฟีณีกีผีธีพ

#### โ ิผีธึีฎีธึีดีจ
ิฒีกึีฅีฌีกีพีพีกีฎ **update_record_in_sheet** ึ **sort_sheet_by_date** ึีธึีถีฏึีซีกีถีฅึ:

```python
# ิฑีพีฅีฌีซ ีณีทีฃึีซีฟ ีฃึีกีผีดีกีถ ีธึีธีถีธึีด
for i, row in enumerate(records, start=2):
    row_id = str(row.get('ID', '')).strip()
    if row_id == record_id:
        record_found = True
        # ีีกีถึีกีดีกีฝีถ ีฌีธีฃีกีพีธึีธึีด
        logger.info(f"ะะฐะนะดะตะฝะฐ ะทะฐะฟะธัั {record_id} ะฒ ัััะพะบะต {i}")
        break

# ิฝีฅีฌีกึีซ ีฝีธึีฟีกีพีธึีธึีด - ีดีซีกีตีถ ีกีถีฐึีกีชีฅีทีฟีธึีฉีตีกีถ ีคีฅีบึีธึีด
if need_resort:
    # ีีกีฏีฅีฟีกีตีซีถ ีฉีกึีดีกึีธึีดี ีกีผีกีถึ ีปีถีปีฅีฌีธึ
    worksheet.update(range_name, sorted_data, value_input_option='USER_ENTERED')
    
# ิฑีดีฝีกีฉีซีพีถีฅึีซ ีกีถีพีฟีกีถีฃ ีดีทีกีฏีธึีด
if field == 'date':
    parsed_date = safe_parse_date_or_none(new_value)
    if parsed_date:
        formatted_value = parsed_date.strftime('%d.%m.%y')
```

## ๐๏ธ ีีฅีญีถีซีฏีกีฏีกีถ ีดีกีถึีกีดีกีฝีธึีฉีตีธึีถีถีฅึ

### ิฑีฝีซีถีญึีธีถ ีกึีขีฅึ (AsyncSheetsWorker)

```python
class AsyncSheetsWorker:
    def __init__(self, max_workers: int = 4):
        self.task_queue = Queue()
        self.workers = []
        
    def _worker_loop(self):
        """ีีซีดีถีกีฏีกีถ ึีซีฏีฌ ีตีธึึีกึีกีถีนีตีธึึ ีกึีขีฅึีซ ีฐีกีดีกึ"""
        while self.running:
            task = self.task_queue.get(timeout=1.0)
            success = self._process_task(task)
            if not success:
                self._retry_task(task)
```

### ิฑีบีกีฐีธีพ ีกีดีฝีกีฉีพีกีตีซีถ ีดีทีกีฏีธึีด

```python
def safe_parse_date(date_str: str) -> datetime.date:
    """ิฑีบีกีฐีธีพ ีกีดีฝีกีฉีพีซ ีดีทีกีฏีธึีด ีขีกีฆีดีกีฉีซีพ ีฑึีกีนีกึีถีฅึีซ ีกีปีกีฏึีธึีฉีตีกีดีข"""
    date_formats = [
        '%d.%m.%y', '%d.%m.%Y', '%Y-%m-%d', 
        '%d-%m-%Y', '%d/%m/%Y', '%dโค%mโค%y'
    ]
    
    for fmt in date_formats:
        try:
            return datetime.strptime(date_str, fmt).date()
        except ValueError:
            continue
    
    raise ValueError(f"ีีฐีกีปีธีฒีพีฅึ ีดีทีกีฏีฅีฌ ีกีดีฝีกีฉีซีพีจ: {date_str}")
```

## ๐ ิฟีกีฟีกึีฅีฌีกีฃีธึีฎีดีกีถ ึีธึึีกีถีซีทีถีฅึ

### Google Sheets ีซีถีฟีฅีฃึีกึีซีก
- **ีีกีญีฏีซีถีธึีด**: ีีซีถีญึีธีถ, 3-5ีพึีฏ ีกีฏีถีฏีกีฌีซึ
- **ีีซีดีก**: ิฑีฝีซีถีญึีธีถ, 0.1ีพึีฏ ีบีกีฟีกีฝีญีกีถ + ึีธีถีกีตีซีถ ีดีทีกีฏีธึีด

### ิฑีดีฝีกีฉีพีกีตีซีถ ีดีทีกีฏีธึีด
- **ีีกีญีฏีซีถีธึีด**: 1 ีฑึีกีนีกึ, ีฐีกีณีกีญีกีฏีซ ีฝีญีกีฌีถีฅึ
- **ีีซีดีก**: 8 ีฑึีกีนีกึ, ีกีบีกีฐีธีพ ีดีทีกีฏีธึีด

### ีีกีฒีธึีคีกีฃึีธึีฉีตีธึีถีถีฅึีซ ีฏีกีผีกีพีกึีธึีด
- **ีีกีญีฏีซีถีธึีด**: ิผึีพีกีฎ ีฆึีธึีตึีถีฅึ
- **ีีซีดีก**: ีีกึีธึึ, ีฏีกีฆีดีกีฏีฅึีบีพีกีฎ ีฆึีธึีตึีถีฅึ

## ๐๏ธ ีีกีตีฌีกีตีซีถ ีฏีกีผีธึึีพีกีฎึ

```
src/
โโโ google_integration/
โ   โโโ async_sheets_worker.py    # ิฑีฝีซีถีญึีธีถ ีกึีขีฅึีถีฅึ
โ   โโโ sheets_manager.py         # Google Sheets API
โโโ utils/
โ   โโโ date_utils.py            # ิฑีดีฝีกีฉีพีกีตีซีถ ึีธึีถีฏึีซีกีถีฅึ
โ   โโโ payment_utils.py         # ีีณีกึีกีตีซีถ ีฃีธึีฎีซึีถีฅึ
โโโ bot/handlers/
โ   โโโ record_handlers.py       # ิณึีกีผีธึีดีถีฅึีซ ีดีทีกีฏีธึีด
โ   โโโ edit_handlers.py         # ิฝีดีขีกีฃึีดีกีถ ีฃีธึีฎีธีฒีธึีฉีตีธึีถีถีฅึ
โ   โโโ payment_handlers.py      # ีีณีกึีกีตีซีถ ีฃีธึีฎีธีฒีธึีฉีตีธึีถีถีฅึ
โโโ main.py                      # ีีซีดีถีกีฏีกีถ ีถีกีญีกีฑีฅีผีถีธึีด
```

## ๐ง ีีฅีฒีกีคึีธึีด ึ ีฃีธึีฎีกึีฏีธึีด

### ีีกีญีกีบีกีตีดีกีถีถีฅึ
```bash
pip install python-telegram-bot
pip install gspread oauth2client
pip install pandas openpyxl
```

### ิณีธึีฎีกึีฏีธึีด
```bash
cd CoordinatBot
python src/main.py
```

### ิฟีกึีฃีกีพีธึีธึีดีถีฅึ
1. **Google Sheets ีดีธึีฟึ**: `credentials/` ีบีกีถีกีฏีธึีด ีฟีฅีฒีกีคึีฅีฌ JSON ึีกีตีฌีจ
2. **ิฒีธีฟีซ ีฟีธีฏีฅีถ**: `.env` ึีกีตีฌีธึีด ีฝีกีฐีดีกีถีฅีฌ `TOKEN=`
3. **ิฑีคีดีซีถีซีฝีฟึีกีฟีธึีถีฅึ**: `config/settings.py`-ีธึีด ีฝีกีฐีดีกีถีฅีฌ `ADMIN_IDS`

## ๐ ิณีธึีฎีกีผีธึีตีฉีถีฅึ

### ีีซีดีถีกีฏีกีถ ีฐึีกีดีกีถีถีฅึ
- `/start` - ิฒีธีฟีซ ีฃีธึีฎีกึีฏีธึีด
- `/menu` - ีีซีดีถีกีฏีกีถ ึีกีถีฏ
- `/help` - ีีฃีถีธึีฉีตีธึีถ

### ิฑีคีดีซีถีซีฝีฟึีกีฟีซีพ ีฐึีกีดีกีถีถีฅึ
- `/allow_user` - ีีฃีฟีกีฟีฅึีซ ีฉีธึีตีฌีฟีพีธึีฉีตีธึีถ
- `/export` - ีีพีตีกีฌีถีฅึีซ ีกึีฟีกีฐีกีถีธึีด
- `/sync_sheets` - Google Sheets ีฝีซีถีญึีธีถีกึีธึีด
- `/set_sheet` - ิฑีฒีตีธึีฝีกีฏีซ ีจีถีฟึีธึีฉีตีธึีถ

### ีีซีดีถีกีฏีกีถ ีฃีธึีฎีกีผีธึีตีฉีถีฅึ
1. **ิณึีกีผีธึีดีถีฅึีซ ีกีพีฅีฌีกึีธึีด** - ิพีกีญีฝีฅึีซ ึ ีฅีฏีกีดีธึีฟีถีฅึีซ ีฃึีกีผีธึีด
2. **ิฒีกึีฉีธีฒีธึีดีถีฅึีซ ีฃึีกีผีธึีด** - ิฑีผีกีถึ ีฎีกีญีฝีซ ึึีฅึีซ ีถีทีธึีด
3. **ีีณีกึีถีฅึีซ ีฏีกีผีกีพีกึีธึีด** - ีีณีกึีกีตีซีถ ีถีฅึีกีฎีกีฏีกีถ ึ ีกึีฟีกีฎีกีฏีกีถ
4. **ิถีฅีฏีธึีตึีถีฅึีซ ีฝีฟีฅีฒีฎีธึีด** - Excel ึีธึีดีกีฟีธีพ ีกึีฟีกีฐีกีถีธึีด
5. **Google Sheets ีฝีซีถีญึีธีถีกึีธึีด** - ิฑีพีฟีธีดีกีฟ ีฉีกึีดีกึีธึีดีถีฅึ

## ๐ ิฑีถีพีฟีกีถีฃีธึีฉีตีธึีถ

### ีีธึีฟึีซ ีพีฅึีกีฐีฝีฏีธึีด
- ิฑีคีดีซีถีซีฝีฟึีกีฟีธึีกีตีซีถ ีฐึีกีดีกีถีถีฅึ ีดีซีกีตีถ ีฉีธึีตีฌีกีฟึีพีกีฎ ึีฃีฟีกีฟีฅึีฅึีซ ีฐีกีดีกึ
- ีีฃีฟีกีฟีฅึีฅึีจ ีฏีกึีธีฒ ีฅีถ ีญีดีขีกีฃึีฅีฌ ีดีซีกีตีถ ีซึีฅีถึ ีฃึีกีผีธึีดีถีฅึีจ
- ิฑีบีกีฐีธีพ Google Sheets API ีดีธึีฟึ

### ีีพีตีกีฌีถีฅึีซ ีบีกีฐีบีกีถีธึีด
- ีีฅีฒีกีฏีกีถ SQLite ีขีกีฆีก ีฟีพีตีกีฌีถีฅึีซ ีฐีกีดีกึ
- ิฑีพีฟีธีดีกีฟ ีบีกีฐีธึีฝีฟีกีพีธึีดีกีถ ีฐีกีดีกีฏีกึีฃ
- ีีกีถึีกีดีกีฝีถ ีฃีธึีฎีธีฒีธึีฉีตีธึีถีถีฅึีซ ีฌีธีฃีกีพีธึีธึีด

## ๐ ีีญีกีฌีถีฅึีซ ีพีกึีธึีด

### ิฑีฝีซีถีญึีธีถ ีฝีญีกีฌีถีฅึ
```python
try:
    success = sheets_manager.add_record_to_sheet(...)
    if not success:
        retry_task_with_backoff(task)
except Exception as e:
    log_error_and_continue(e)
```

### ิฑีดีฝีกีฉีพีกีตีซีถ ีฝีญีกีฌีถีฅึ
```python
parsed_date = safe_parse_date_or_none(date_string)
if parsed_date is None:
    log_warning_and_skip_record(date_string)
    continue
```

## ๐ ิฑึีคีซีกึีดีกีถ ีบีกีฟีดีธึีฉีตีธึีถ

### v2.0.0 (ิธีถีฉีกึีซีฏ)
- โ ิฑีฝีซีถีญึีธีถ Google Sheets ีดีทีกีฏีธึีด
- โ ิฒีกึีฅีฌีกีพีพีกีฎ ีกีดีฝีกีฉีพีกีตีซีถ ีฐีกีดีกีฏีกึีฃ  
- โ ีีกีฒีธึีคีกีฃึีธึีฉีตีธึีถีถีฅึีซ ีกีพีฟีธีดีกีฟ ีดีกึึีธึีด
- โ ิฟีกีตีธึีถ ีฝีญีกีฌีถีฅึีซ ีพีกึีธึีด
- โ ิณึีกีผีธึีดีถีฅึีซ ีฉีกึีดีกึีดีกีถ ีฝีญีกีฌีถีฅึีซ ีธึีฒีฒีธึีด

### v1.0.0
- โ ีีซีดีถีกีฏีกีถ ีขีธีฟีซ ีฃีธึีฎีกีผีธึีตีฉีถีฅึ
- โ Google Sheets ีซีถีฟีฅีฃึีกึีซีก
- โ ีีฃีฟีกีฟีฅึีฅึีซ ีฏีกีผีกีพีกึีธึีด
- โ ีีณีกึีกีตีซีถ ีฐีกีดีกีฏีกึีฃ

## ๐ก ิฑีบีกีฃีก ีฎึีกีฃึีฅึ

- [ ] ีีฅีข ีซีถีฟีฅึึีฅีตีฝ ีกีพีฅีฌีกึีธึีด
- [ ] ีีธีขีซีฌีกีตีซีถ ีฐีกีพีฅีฌีพีกีฎ
- [ ] BI ีคีกีทีฟ (dashboard) ีซีถีฟีฅีฃึีกึีซีก  
- [ ] ิฑีพีฟีธีดีกีฟ ีฆีฅีฏีธึีตึีถีฅึีซ ีกีผีกึีธึีด
- [ ] ิฒีกีฆีดีกีฌีฅีฆีธึ ีกีปีกีฏึีธึีฉีตีธึีถ ีจีถีคีฌีกีตีถีธึีด

## ๐ ิฑีปีกีฏึีธึีฉีตีธึีถ

ิฝีถีคีซึีถีฅึีซ ีฏีกีด ีกีผีกีปีกึีฏีธึีฉีตีธึีถีถีฅึีซ ีคีฅีบึีธึีด ีฏีกึีธีฒ ีฅึ:
1. ีีฟีฅีฒีฎีฅีฌ GitHub Issue
2. ิฟีกีบีพีฅีฌ ีฎึีกีฃึีกีพีธึีธีฒีถีฅึีซ ีฐีฅีฟ
3. ีึีฒีกึีฏีฅีฌ ีฌีธีฃ ึีกีตีฌีฅึ ีฝีญีกีฌีซ ีพีฅึีฌีธึีฎีธึีฉีตีกีถ ีฐีกีดีกึ

---

**ีีทีธึีด**: ิฑีตีฝ ีขีธีฟีจ ีดีทีกีฏีพีฅีฌ ีง ีฐีกีฟีธึีฏ CoordinatBot ีฎึีกีฃึีซ ีฐีกีดีกึ ึ ีบีกีฐีกีถีปีธึีด ีง ีฐีกีดีกีบีกีฟีกีฝีญีกีถ ีฏีกึีฃีกีพีธึีธึีดีถีฅึ Google Sheets API-ีซ ึ Telegram Bot API-ีซ ีฐีกีดีกึ:
